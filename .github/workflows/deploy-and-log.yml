name: Deploy All Workers & Capture Logs

on:
  push:
    branches: [main]

permissions:
  contents: read
  actions: write
  issues: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      # Inject shared/ folder into each worker that needs it
      # Workers import from '../shared/types/*' which resolves relative to src/
      # e.g., src/index.ts importing '../shared/types/security' resolves to
      # workerDir/shared/types/security (one level up from src/)
      - name: Inject shared folder into workers
        run: |
          for worker in account.xaostech.io api.xaostech.io blog.xaostech.io chat.xaostech.io data.xaostech.io lingua.xaostech.io payments.xaostech.io portfolio.xaostech.io xaostech.io; do
            if [ -d "$worker" ]; then
              echo "Injecting shared/ into $worker..."
              rm -rf "$worker/shared"
              cp -r shared "$worker/shared"
            fi
          done

      - name: Deploy account worker
        id: account
        continue-on-error: true
        run: |
          cd account.xaostech.io
          npm install
          npm run deploy 2>&1 | tee /tmp/account-deploy.log
          cat /tmp/account-deploy.log >> $GITHUB_STEP_SUMMARY

      - name: Deploy api worker
        id: api
        continue-on-error: true
        run: |
          cd api.xaostech.io
          npm install
          npm run deploy 2>&1 | tee /tmp/api-deploy.log
          cat /tmp/api-deploy.log >> $GITHUB_STEP_SUMMARY

      - name: Deploy blog worker
        id: blog
        continue-on-error: true
        run: |
          cd blog.xaostech.io
          npm install
          npm run deploy 2>&1 | tee /tmp/blog-deploy.log
          cat /tmp/blog-deploy.log >> $GITHUB_STEP_SUMMARY

      - name: Deploy chat worker
        id: chat
        continue-on-error: true
        run: |
          cd chat.xaostech.io
          npm install
          npm run deploy 2>&1 | tee /tmp/chat-deploy.log
          cat /tmp/chat-deploy.log >> $GITHUB_STEP_SUMMARY

      - name: Deploy data worker
        id: data
        continue-on-error: true
        run: |
          cd data.xaostech.io
          npm install
          npm run deploy 2>&1 | tee /tmp/data-deploy.log
          cat /tmp/data-deploy.log >> $GITHUB_STEP_SUMMARY

      - name: Deploy lingua worker
        id: lingua
        continue-on-error: true
        run: |
          cd lingua.xaostech.io
          npm install
          npm run deploy 2>&1 | tee /tmp/lingua-deploy.log
          cat /tmp/lingua-deploy.log >> $GITHUB_STEP_SUMMARY

      - name: Deploy payments worker
        id: payments
        continue-on-error: true
        run: |
          cd payments.xaostech.io
          npm install
          npm run deploy 2>&1 | tee /tmp/payments-deploy.log
          cat /tmp/payments-deploy.log >> $GITHUB_STEP_SUMMARY

      - name: Deploy portfolio worker
        id: portfolio
        continue-on-error: true
        run: |
          cd portfolio.xaostech.io
          npm install
          npm run deploy 2>&1 | tee /tmp/portfolio-deploy.log
          cat /tmp/portfolio-deploy.log >> $GITHUB_STEP_SUMMARY

      - name: Deploy landing page
        id: landing
        continue-on-error: true
        run: |
          cd xaostech.io
          npm install
          npm run deploy 2>&1 | tee /tmp/landing-deploy.log
          cat /tmp/landing-deploy.log >> $GITHUB_STEP_SUMMARY

      - name: Upload all logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-logs
          path: /tmp/*-deploy.log
          retention-days: 30

      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const logs = ['account', 'api', 'blog', 'chat', 'data', 'lingua', 'payments', 'portfolio', 'landing'];
            let comment = '## Deploy Results\n\n';
            logs.forEach(worker => {
              const path = `/tmp/${worker}-deploy.log`;
              if (fs.existsSync(path)) {
                const content = fs.readFileSync(path, 'utf8');
                const status = content.includes('✘ [ERROR]') ? '❌' : '✅';
                comment += `### ${status} ${worker}\n\`\`\`\n${content.slice(-500)}\n\`\`\`\n\n`;
              }
            });
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
